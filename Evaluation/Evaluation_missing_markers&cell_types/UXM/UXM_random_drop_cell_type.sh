#!/bin/bash
##UXM_workflow##
#Evaluation of cell type(s) in the reference methylation atlas

#j: Two sets of cfDNA mixture data: Uniform Distribution and constrained Random Distribution
for j in uniform_dis Constrained_random_dis 
do
    #i: cell type(s) we will drop
    for i in Endothelium Blood-Granul Adipocytes Blood-NK Head-Neck-Ep  Blood-B Blood-Granul Blood-Mono+Macro Blood-NK Blood-T PB FE BL TC HH GC TS BO NL MB 
    do
	#Segmentation: Segment the region into homogenously methylated blocks 
	#ref_dir/*beta: reference beta files are generated by DataProcessing/preProcessing.ipynb script.
        wgbstools segment --betas ref_dir/*beta --min_cpg 4 --max_bp 5000 -o output_dir/blocks.small.bed --genome hg38
		
	#Index bed
	wgbstools index output_dir/blocks.small.bed
		
	#DMRs
	wgbstools find_markers --blocks_path output_dir/blocks.small.bed.gz --groups group.csv --betas ref_dir/*beta --pval 0.05 --min_bp 10 --min_cpg 5 --only_hypo --sort_by delta_means --tg_quant 0.25 --bg_quant 0.025 --top 25 --min_cov 15 -o output_dir/selected_markers/filter_15_markers
	cat output_dir/selected_markers/filter_15_markers/*bed > output_dir/selected_markers/filter_15_markers/filter_15_markers.bed
		
	#Generate reference atlas that drop certain cell type(s)
	#ref_dir/*pat.gz: Reference pat files. Generated by dataProcessing/preProcessing.ipynb script along with beta files from the previous step
	sed '/${i}/d' output_dir/selected_markers/filter_15_markers/filter_15_markers.bed > output_dir/cell_type_drop/drop_${i}/drop_${i}_markers.bed
	uxm build --markers output_dir/cell_type_drop/drop_${i}/drop_${i}_markers.bed --groups drop_${i}_group.csv --pats ref_dir/*pat.gz -o output_dir/cell_type_drop/drop_${i}/Atlas.d15.l5.hg38.tsv -l 5 
	    
	#Running deconvolution 
	#${j}/*pat.gz: One or more pat files to deconvolve.
	uxm deconv ${j}/*pat.gz -o output_dir/cell_type_drop/${j}_deconv_out/drop_${i}.csv --atlas output_dir/cell_type_drop/drop_${i}/Atlas.d15.l5.hg38.tsv
    done
done

