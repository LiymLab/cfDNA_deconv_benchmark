#!/bin/bash
##UXM_workflow##
#This script can be used to assess the impact of sequencing depth in the raw reference data used to generate the reference atlas on marker selection quality and deconvolution performance

#j: cfDNA mixture dataset: Uniform Distribution ã€ constrained Random Distribution and dirichlet distribution
for j in uniform_dis Constrained_random_dis dirichlet_dis
do
    #Segmentation: segment the region into homogenously methylated blocks
    #If a subsample of raw reference data is needed, the raw_ref_filter.sh script can be used to generate beta/pat files.
    #i: different sequencing depth in the raw reference data.
    for i in 85 71 57 43 28 14 3
    do
      wgbstools segment --betas ref_dir/$i/*beta --min_cpg 4 --max_bp 5000 -o output_dir/$i/blocks.small.bed --genome hg38
    
    #Index bed
      wgbstools index output_dir/$i/blocks.small.bed
   
    #DMR
	  #ref_dir/$i/*beta: a set of beta files to find the DMR for.
	  #group file: a csv table\ text file defining which beta files are case and which are control, or other groups.
	
 	    wgbstools find_markers --blocks_path output_dir/$i/blocks.small.bed.gz --groups group.csv --betas ref_dir/$i/*beta --pval 0.05 --min_bp 10 --min_cpg 5 --only_hypo --sort_by delta_means --tg_quant 0.25 --bg_quant 0.025 --top 25 --min_cov 15 -o output_dir/selected_markers/ref_${i}_markers
	    cat output_dir/selected_markers/ref_${i}_markers/*bed > output_dir/selected_markers/ref_${i}_markers/ref_${i}_markers.bed
		
	  #Reference atlas
	  #ref_dir/*pat.gz: reference pat files. Generated by dataProcessing/preProcessing.ipynb script along with beta files from the previous step
	    uxm build --markers output_dir/selected_markers/ref_${i}_markers/ref_${i}_markers.bed --groups group.csv --pats ref_dir/$i/*pat.gz -o output_dir/selected_markers/ref_${i}_markers/Atlas.d${i}.l5.hg38.tsv -l 5
		
	  #Running deconvolution 
	  #${j}/*pat.gz: one or more sample pat files to deconvolve.
    #--atlas: path to atlas generated by uxm build.
      uxm deconv ${j}/*pat.gz -o output_dir/depth_filter/${j}_deconv_out/depth_${i}.csv --atlas output_dir/selected_markers/ref_${i}_markers/Atlas.d${i}.l5.hg38.tsv 
    done
done
